<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>koala bear</title>
    <description>è§‚æ°´æœ‰æœ¯ï¼Œå¿…è§‚å…¶æ¾œï¼Œæ—¥æœˆæœ‰æ˜ï¼Œå®¹å…‰å¿…ç…§ã€‚
</description>
    <link>http://wsfdl.com/</link>
    <atom:link href="http://wsfdl.com/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Sat, 26 Dec 2015 14:23:39 +0800</pubDate>
    <lastBuildDate>Sat, 26 Dec 2015 14:23:39 +0800</lastBuildDate>
    <generator>Jekyll v3.0.1</generator>
    
      <item>
        <title>ç†è§£keystoneçš„å››ç§token</title>
        <description>
&lt;hr /&gt;
&lt;p&gt;layout: post
title: â€œç†è§£Keystoneçš„å››ç§Tokenâ€
categories: OpenStack
â€”&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;token-&quot;&gt;Token æ˜¯ä»€ä¹ˆ&lt;/h1&gt;

&lt;p&gt;é€šä¿—çš„è®²ï¼Œtoken æ˜¯ç”¨æˆ·çš„ä¸€ç§å‡­è¯ï¼Œéœ€æ‹¿æ­£ç¡®çš„ç”¨æˆ·å/å¯†ç å‘ keystone ç”³è¯·æ‰èƒ½å¾—åˆ°ã€‚å¦‚æœç”¨æˆ·æ¯æ¬¡éƒ½é‡‡ç”¨ç”¨æˆ·å/å¯†ç è®¿é—® OpenStack APIï¼Œå®¹æ˜“æ³„éœ²ç”¨æˆ·ä¿¡æ¯ï¼Œå¸¦æ¥å®‰å…¨éšæ‚£ã€‚æ‰€ä»¥ OpenStack è¦æ±‚ç”¨æˆ·è®¿é—®å…¶ API å‰ï¼Œå¿…é¡»å…ˆè·å– tokenï¼Œç„¶åç”¨ token ä½œä¸ºç”¨æˆ·å‡­æ®è®¿é—® OpenStack APIã€‚
&lt;img src=&quot;http://7xp2eu.com1.z0.glb.clouddn.com/uuid.png&quot; alt=&quot;P1&quot; /&gt;&lt;/p&gt;

&lt;h1 id=&quot;token--1&quot;&gt;å››ç§ Token çš„ç”±æ¥&lt;/h1&gt;
&lt;p&gt;D ç‰ˆæœ¬æ—¶ï¼Œä»…æœ‰ UUID ç±»å‹çš„ Tokenï¼ŒUUID token ç®€å•æ˜“ç”¨ï¼Œå´å®¹æ˜“ç»™ Keystone å¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œä»å›¾ä¸€çš„æ­¥éª¤ 4 å¯çœ‹å‡ºï¼Œæ¯å½“ OpenStack API æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œéƒ½éœ€è¦å‘ Keystone éªŒè¯è¯¥ token æ˜¯å¦æœ‰æ•ˆã€‚éšç€é›†ç¾¤è§„æ¨¡çš„æ‰©å¤§ï¼ŒKeystone éœ€å¤„ç†å¤§é‡éªŒè¯ token çš„è¯·æ±‚ï¼Œåœ¨é«˜å¹¶å‘ä¸‹å®¹æ˜“å‡ºç°æ€§èƒ½é—®é¢˜ã€‚&lt;/p&gt;

&lt;p&gt;äºæ˜¯ï¼ŒPKI(&lt;a href=&quot;https://wiki.openstack.org/wiki/PKI&quot;&gt;Public Key Infrastructrue&lt;/a&gt;) token åœ¨ G ç‰ˆæœ¬è¿ç”¨è€Œç”Ÿï¼Œå’Œ UUID ç›¸æ¯”ï¼ŒPKI token æºå¸¦æ›´å¤šç”¨æˆ·ä¿¡æ¯çš„åŒæ—¶è¿˜é™„ä¸Šäº†æ•°å­—ç­¾åï¼Œä»¥æ”¯æŒæœ¬åœ°è®¤è¯ï¼Œä»è€Œé¿å…äº†æ­¥éª¤ 4ã€‚å› ä¸º PKI token æºå¸¦äº†æ›´å¤šçš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å°±åŒ…æ‹¬ service catalogï¼Œéšç€ OpenStack çš„ Region æ•°å¢å¤šï¼Œservice catalog æºå¸¦çš„ endpoint æ•°é‡è¶Šå¤šï¼ŒPKI token ä¹Ÿç›¸åº”å¢å¤§ï¼Œå¾ˆå®¹æ˜“è¶…å‡º HTTP Server å…è®¸çš„æœ€å¤§ HTTP Header(é»˜è®¤ä¸º 8 KB)ï¼Œå¯¼è‡´ HTTP è¯·æ±‚å¤±è´¥ã€‚&lt;/p&gt;

&lt;p&gt;é¡¾åæ€ä¹‰ï¼Œ&lt;a href=&quot;https://blueprints.launchpad.net/keystone/+spec/compress-tokens&quot;&gt;PKIZ token&lt;/a&gt; å°±æ˜¯ PKI token çš„å‹ç¼©ç‰ˆï¼Œä½†å‹ç¼©æ•ˆæœæœ‰é™ï¼Œæ— æ³•è‰¯å¥½çš„å¤„ç† token size è¿‡å¤§é—®é¢˜ã€‚&lt;/p&gt;

&lt;p&gt;å‰ä¸‰ç§ token éƒ½ä¼šæŒä¹…æ€§å­˜äºæ•°æ®åº“ï¼Œå¤§é‡ä¸æ—¥ä¿±å¢çš„ token å¼•èµ·æ•°æ®åº“æ€§èƒ½ä¸‹é™ï¼Œæ‰€ä»¥ç”¨æˆ·éœ€ç»å¸¸æ¸…ç†æ•°æ®åº“çš„ tokenã€‚ä¸ºäº†é¿å…è¯¥é—®é¢˜ï¼Œç¤¾åŒºæå‡ºäº† Fernet tokenï¼Œå®ƒæºå¸¦äº†å°‘é‡çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¤§å°çº¦ä¸º 255 Byteï¼Œé‡‡ç”¨äº†å¯¹ç§°åŠ å¯†ï¼Œæ— éœ€å­˜äºæ•°æ®åº“ä¸­ã€‚&lt;/p&gt;

&lt;h1 id=&quot;uuid&quot;&gt;UUID&lt;/h1&gt;
&lt;p&gt;UUID token æ˜¯é•¿åº¦å›ºå®šä¸º 32 Byte çš„éšæœºå­—ç¬¦ä¸²ï¼Œç”± uuid.uuid4().hex ç”Ÿæˆã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def _get_token_id(self, token_data):
    return uuid.uuid4().hex
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä½†æ˜¯å›  UUID token ä¸æºå¸¦å…¶å®ƒä¿¡æ¯ï¼ŒOpenStack API æ”¶åˆ°è¯¥ token åï¼Œæ—¢ä¸èƒ½åˆ¤æ–­è¯¥ token æ˜¯å¦æœ‰æ•ˆï¼Œæ›´æ— æ³•å¾—çŸ¥è¯¥ token æºå¸¦çš„ç”¨æˆ·ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€ç»å›¾ä¸€æ­¥éª¤ 4 å‘ Keystone æ ¡éªŒ tokenï¼Œå¹¶è·ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ã€‚å…¶æ ·ä¾‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;144d8a99a42447379ac37f78bf0ef608
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;UUID token ç®€å•ç¾è§‚ï¼Œä¸æºå¸¦å…¶å®ƒä¿¡æ¯ï¼Œå› æ­¤ Keystone å¿…é¡»å®ç° token çš„å­˜å‚¨å’Œè®¤è¯ï¼Œéšç€é›†ç¾¤çš„è§„æ¨¡å¢å¤§ï¼ŒKeystone å°†å¾ˆæœ‰å¯èƒ½æˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚&lt;/p&gt;

&lt;h1 id=&quot;pki&quot;&gt;PKI&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;http://7xp2eu.com1.z0.glb.clouddn.com/pki.png&quot; alt=&quot;P2&quot; /&gt;
åœ¨é˜è¿° PKIï¼ˆPublic Key Infrastructionï¼‰ token å‰ï¼Œè®©æˆ‘ä»¬ç®€å•çš„å›é¡¾&lt;a href=&quot;https://zh.wikipedia.org/wiki/%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86&quot;&gt;å…¬å¼€å¯†é’¥åŠ å¯†(public-key cryptography)&lt;/a&gt;å’Œ&lt;a href=&quot;http://www.youdzone.com/signature.html&quot;&gt;æ•°å­—ç­¾å&lt;/a&gt;ã€‚å…¬å¼€å¯†é’¥åŠ å¯†ï¼Œä¹Ÿç§°ä¸ºéå¯¹ç§°åŠ å¯†(asymmetric cryptographyï¼ŒåŠ å¯†å¯†é’¥å’Œè§£å¯†å¯†é’¥ä¸ç›¸åŒ)ï¼Œåœ¨è¿™ç§å¯†ç å­¦æ–¹æ³•ä¸­ï¼Œéœ€è¦ä¸€å¯¹å¯†é’¥ï¼Œåˆ†åˆ«ä¸ºå…¬é’¥(Public Key)å’Œç§é’¥(Private Key)ï¼Œå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œç§é’¥æ˜¯éå…¬å¼€çš„ï¼Œéœ€ç”¨æˆ·å¦¥å–„ä¿ç®¡ã€‚å¦‚æœæŠŠåŠ å¯†å’Œè§£å¯†çš„æµç¨‹å½“åšå‡½æ•° C(x) å’Œ D(x)ï¼ŒP å’Œ S åˆ†åˆ«ä»£è¡¨å…¬é’¥å’Œç§é’¥ï¼Œå¯¹æ˜æ–‡ A å’Œå¯†æ–‡ B è€Œè¨€ï¼Œæ•°å­¦çš„è§’åº¦ä¸Šæœ‰ä»¥ä¸‹å…¬å¼ï¼š
B = C(A, S)
A = D(B, P)
å…¶ä¸­åŠ å¯†å‡½æ•° C(x), è§£å¯†å‡½æ•° D(x) ä»¥åŠå…¬é’¥ P å‡æ˜¯å…¬å¼€çš„ã€‚ä¸Šé¢ä¸¤ä¸ªå…¬å¼çš„æ„æ€æ˜¯å…¬é’¥åŠ å¯†çš„å¯†æ–‡åªèƒ½ç”¨ç§é’¥è§£å¯†ï¼Œé‡‡ç”¨ç§é’¥åŠ å¯†çš„å¯†æ–‡åªèƒ½ç”¨å…¬é’¥è§£å¯†ã€‚éå¯¹ç§°åŠ å¯†å¹¿æ³›è¿ç”¨åœ¨å®‰å…¨é¢†åŸŸï¼Œè¯¸å¦‚å¸¸è§çš„ HTTPSï¼ŒSSH ç™»å½•ç­‰ã€‚&lt;/p&gt;

&lt;p&gt;æ•°å­—ç­¾ååˆç§°ä¸ºå…¬é’¥æ•°å­—ç­¾åï¼Œé¦–å…ˆé‡‡ç”¨ Hash å‡½æ•°å¯¹æ¶ˆæ¯ç”Ÿæˆæ‘˜è¦ï¼Œæ‘˜è¦ç»ç§é’¥åŠ å¯†åç§°ä¸ºæ•°å­—ç­¾åã€‚æ¥æ”¶æ–¹ç”¨å…¬é’¥è§£å¯†è¯¥æ•°å­—ç­¾åï¼Œå¹¶ä¸æ¥æ”¶æ¶ˆæ¯ç”Ÿæˆçš„æ‘˜è¦åšå¯¹æ¯”ï¼Œå¦‚æœäºŒè€…ä¸€è‡´ï¼Œä¾¿å¯ä»¥ç¡®è®¤è¯¥æ¶ˆæ¯çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚&lt;/p&gt;

&lt;p&gt;PKI çš„æœ¬è´¨å°±æ˜¯åŸºäºæ•°å­—ç­¾åï¼Œkeystone ç”¨ç§é’¥å¯¹ token è¿›è¡Œæ•°å­—ç­¾åï¼Œå„ä¸ª API server ç”¨å…¬é’¥åœ¨æœ¬åœ°éªŒè¯è¯¥ tokenã€‚ç›¸å…³ä»£ç ç®€åŒ–å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def _get_token_id(self, token_data):
    try:
        token_json = jsonutils.dumps(token_data, cls=utils.PKIEncoder)
        token_id = str(cms.cms_sign_token(token_json,
                                          CONF.signing.certfile,
                                          CONF.signing.keyfile))
        return token_id
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ cms.cms_sign_token è°ƒç”¨ openssl cms â€“sign å¯¹ token_data è¿›è¡Œç­¾åï¼Œtoken_data çš„æ ·å¼å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;{
  &quot;token&quot;: {
    &quot;methods&quot;: [
      &quot;password&quot;
    ],
    &quot;roles&quot;: [
      {
        &quot;id&quot;: &quot;5642056d336b4c2a894882425ce22a86&quot;,
        &quot;name&quot;: &quot;admin&quot;
      }
    ],
    &quot;expires_at&quot;: &quot;2015-12-25T09:57:28.404275Z&quot;,
    &quot;project&quot;: {
      &quot;domain&quot;: {
        &quot;id&quot;: &quot;default&quot;,
        &quot;name&quot;: &quot;Default&quot;
      },
      &quot;id&quot;: &quot;144d8a99a42447379ac37f78bf0ef608&quot;,
      &quot;name&quot;: &quot;admin&quot;
    },
    &quot;catalog&quot;: [
      {
        &quot;endpoints&quot;: [
          {
            &quot;region_id&quot;: &quot;RegionOne&quot;,
            &quot;url&quot;: &quot;http://controller:5000/v2.0&quot;,
            &quot;region&quot;: &quot;RegionOne&quot;,
            &quot;interface&quot;: &quot;public&quot;,
            &quot;id&quot;: &quot;3837de623efd4af799e050d4d8d1f307&quot;
          },
          {
            &quot;region_id&quot;: &quot;RegionOne&quot;,
            &quot;url&quot;: &quot;http://controller:35357/v2.0&quot;,
            &quot;region&quot;: &quot;RegionOne&quot;,
            &quot;interface&quot;: &quot;admin&quot;,
            &quot;id&quot;: &quot;3ffc46344293437ca2919107980daee4&quot;
          },
          {
            &quot;region_id&quot;: &quot;RegionOne&quot;,
            &quot;url&quot;: &quot;http://controller:5000/v2.0&quot;,
            &quot;region&quot;: &quot;RegionOne&quot;,
            &quot;interface&quot;: &quot;internal&quot;,
            &quot;id&quot;: &quot;c138238caeb04bb391ea0957ac020ccc&quot;
          }
        ],
        &quot;type&quot;: &quot;identity&quot;,
        &quot;id&quot;: &quot;888accf6f1364001af0b829f51d905c3&quot;,
        &quot;name&quot;: &quot;keystone&quot;
      }
    ],
    &quot;extras&quot;: {
    },
    &quot;user&quot;: {
      &quot;domain&quot;: {
        &quot;id&quot;: &quot;default&quot;,
        &quot;name&quot;: &quot;Default&quot;
      },
      &quot;id&quot;: &quot;1552d60a042e4a2caa07ea7ae6aa2f09&quot;,
      &quot;name&quot;: &quot;admin&quot;
    },
    &quot;audit_ids&quot;: [
      &quot;ZCvZW2TtTgiaAsVA8qmc3A&quot;
    ],
    &quot;issued_at&quot;: &quot;2015-12-25T08:57:28.404304Z&quot;
  }
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;token_data ç» cms.cms_sign_token ç­¾åç”Ÿæˆçš„ token_id å¦‚ä¸‹ï¼Œå…± 1932 Byteï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;MIIKoZIhvcNAQcCoIIFljCCBZICAQExDTALBglghkgBZQMEAgEwggPzBgkqhkiG9w0BBwGgggPkBIID4HsidG9rZW4iOnsibWV0aG9kcyI6Wy......+aRbfbxLTTz14fLX53QrHgcfuAl27dw+Vo4GzZ-D2Hrhr0acV3bMKzmqvViHf-fPVnLDMJajOWSuhimqfLZHRdr+ck0WVQosB6+M6iAvrEF7v
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;pkiz&quot;&gt;PKIZ&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;http://7xp2eu.com1.z0.glb.clouddn.com/pkiz.png&quot; alt=&quot;P3&quot; /&gt;
PKIZ åœ¨ PKI çš„åŸºç¡€ä¸Šåšäº†å‹ç¼©å¤„ç†ï¼Œä½†æ˜¯å‹ç¼©çš„æ•ˆæœæå…¶æœ‰é™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå‹ç¼©åçš„å¤§å°ä¸º PKI token çš„ 90 % å·¦å³ï¼Œæ‰€ä»¥ PKIZ ä¸èƒ½å‹å¥½çš„è§£å†³ token size å¤ªå¤§é—®é¢˜ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def _get_token_id(self, token_data):
    try:
        token_json = jsonutils.dumps(token_data, cls=utils.PKIEncoder)
        token_id = str(cms.pkiz_sign(token_json,
                                     CONF.signing.certfile,
                                     CONF.signing.keyfile))
        return token_id
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å…¶ä¸­ cms.pkiz_sign() æ¯” cms.pki_sign() å¤šäº†å¦‚ä¸‹ä¸€è¡Œä»£ç ï¼Œç”± zlib å¯¹ç­¾ååçš„æ¶ˆæ¯è¿›è¡Œå‹ç¼©çº§åˆ«ä¸º 6 çš„å‹ç¼©ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;compressed = zlib.compress(token_id, compression_level=6)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;PKIZ token æ ·ä¾‹å¦‚ä¸‹ï¼Œå…± 1645 Byteï¼Œæ¯” PKI token å‡å° 14.86 %ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;PKIZ_eJytVcuOozgU3fMVs49aTXhUN0vAQEHFJiRg8IVHgn5OnA149JVaunNS3NYjoSUri2r885957Lly_iZzmej_6y4XZSJB33eHiAZvRZX9xyZU......W4fRaxrbNtinB2ze3PXjv3sMqqvzunYxFa_fO1tyb0jteB0czPKKt97rojheVICXYrEk0oPX6TSnP71IYj2e3nm4MLy7S84PtIPDz4_03IsOb2Q=
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;fernet&quot;&gt;Fernet&lt;/h1&gt;
&lt;p&gt;&lt;img src=&quot;http://7xp2eu.com1.z0.glb.clouddn.com/fernet.png&quot; alt=&quot;P4&quot; /&gt;
ç”¨æˆ·å¯èƒ½ä¼šç¢°ä¸Šè¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼Œå½“é›†ç¾¤è¿è¡Œè¾ƒé•¿ä¸€æ®µæ—¶é—´åï¼Œè®¿é—®å…¶ API ä¼šå˜å¾—å¥‡æ…¢æ— æ¯”ï¼Œç©¶å…¶åŸå› åœ¨äº Keystone æ•°æ®åº“å­˜å‚¨äº†å¤§é‡çš„ token å¯¼è‡´æ€§èƒ½å¤ªå·®ï¼Œè§£å†³çš„åŠæ³•æ˜¯ç»å¸¸æ¸…ç† tokenã€‚ä¸ºäº†é¿å…ä¸Šè¿°é—®é¢˜ï¼Œç¤¾åŒºæå‡ºäº†&lt;a href=&quot;https://github.com/openstack/keystone-specs/blob/master/specs/kilo/klwt.rst&quot;&gt;Fernet token&lt;/a&gt;ï¼Œå®ƒé‡‡ç”¨ &lt;a href=&quot;http://cryptography.readthedocs.org/en/latest/fernet/&quot;&gt;cryptography&lt;/a&gt; å¯¹ç§°åŠ å¯†åº“(symmetric cryptographyï¼ŒåŠ å¯†å¯†é’¥å’Œè§£å¯†å¯†é’¥ç›¸åŒ) åŠ å¯† tokenï¼Œå…·ä½“ç”± AES-CBC åŠ å¯†å’Œæ•£åˆ—å‡½æ•° SHA256 ç­¾åã€‚&lt;a href=&quot;http://cryptography.readthedocs.org/en/latest/fernet/&quot;&gt;Fernet&lt;/a&gt;
æ˜¯ä¸“ä¸º API token è®¾è®¡çš„ä¸€ç§è½»é‡çº§å®‰å…¨æ¶ˆæ¯æ ¼å¼ï¼Œä¸éœ€è¦å­˜å‚¨äºæ•°æ®åº“ï¼Œå‡å°‘äº†ç£ç›˜çš„ IOï¼Œå¸¦æ¥äº†ä¸€å®šçš„&lt;a href=&quot;http://dolphm.com/benchmarking-openstack-keystone-token-formats/&quot;&gt;æ€§èƒ½æå‡&lt;/a&gt;ã€‚ä¸ºäº†æé«˜å®‰å…¨æ€§ï¼Œéœ€è¦é‡‡ç”¨ &lt;a href=&quot;http://lbragstad.com/fernet-tokens-and-key-rotation/&quot;&gt;Key Rotation&lt;/a&gt; æ›´æ¢å¯†é’¥ã€‚&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def create_token(self, user_id, expires_at, audit_ids, methods=None,
                 domain_id=None, project_id=None, trust_id=None,
                 federated_info=None):
    &quot;&quot;&quot;Given a set of payload attributes, generate a Fernet token.&quot;&quot;&quot;
    
    if trust_id:
        version = TrustScopedPayload.version
        payload = TrustScopedPayload.assemble(
            user_id,
            methods,
            project_id,
            expires_at,
            audit_ids,
            trust_id)
    
    ...
    
    versioned_payload = (version,) + payload
    serialized_payload = msgpack.packb(versioned_payload)
    token = self.pack(serialized_payload)

    return token
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä»¥ä¸Šä»£ç è¡¨æ˜ï¼Œtoken åŒ…å«äº† user_idï¼Œproject_idï¼Œdomain_idï¼Œmethodsï¼Œexpires_at ç­‰ä¿¡æ¯ï¼Œé‡è¦çš„æ˜¯ï¼Œå®ƒæ²¡æœ‰ service_catalogï¼Œæ‰€ä»¥ region çš„æ•°é‡å¹¶ä¸å½±å“å®ƒçš„å¤§å°ã€‚self.pack() æœ€ç»ˆè°ƒç”¨å¦‚ä¸‹ä»£ç å¯¹ä¸Šè¿°ä¿¡æ¯åŠ å¯†ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def crypto(self):
    keys = utils.load_keys()

    if not keys:
        raise exception.KeysNotFound()

    fernet_instances = [fernet.Fernet(key) for key in utils.load_keys()]
    return fernet.MultiFernet(fernet_instances)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;è¯¥ token çš„å¤§å°ä¸€èˆ¬åœ¨ 200 å¤š Byte å·¦å³ï¼Œæœ¬ä¾‹æ ·å¼å¦‚ä¸‹ï¼Œå¤§å°ä¸º 186 Byteï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;gAAAAABWfX8riU57aj0tkWdoIL6UdbViV-632pv0rw4zk9igCZXgC-sKwhVuVb-wyMVC9e5TFc7uPfKwNlT6cnzLalb3Hj0K3bc1X9ZXhde9C2ghsSfVuudMhfR8rThNBnh55RzOB8YTyBnl9MoQXBO5UIFvC7wLTh_2klihb6hKuUqB6Sj3i_8
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&quot;token&quot;&gt;å¦‚ä½•é€‰æ‹© Token&lt;/h1&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Token ç±»å‹&lt;/th&gt;
      &lt;th&gt;UUID&lt;/th&gt;
      &lt;th&gt;PKI&lt;/th&gt;
      &lt;th&gt;PKIZ&lt;/th&gt;
      &lt;th&gt;Fernet&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;å¤§å°&lt;/td&gt;
      &lt;td&gt;32 Byte&lt;/td&gt;
      &lt;td&gt;KB çº§åˆ«&lt;/td&gt;
      &lt;td&gt;KB çº§åˆ«&lt;/td&gt;
      &lt;td&gt;çº¦ 255 Byte&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;æ”¯æŒæœ¬åœ°è®¤è¯&lt;/td&gt;
      &lt;td&gt;ä¸æ”¯æŒ&lt;/td&gt;
      &lt;td&gt;æ”¯æŒ&lt;/td&gt;
      &lt;td&gt;æ”¯æŒ&lt;/td&gt;
      &lt;td&gt;ä¸æ”¯æŒ&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;Keystone è´Ÿè½½&lt;/td&gt;
      &lt;td&gt;å¤§&lt;/td&gt;
      &lt;td&gt;å°&lt;/td&gt;
      &lt;td&gt;å°&lt;/td&gt;
      &lt;td&gt;å¤§&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;å­˜å‚¨äºæ•°æ®åº“&lt;/td&gt;
      &lt;td&gt;æ˜¯&lt;/td&gt;
      &lt;td&gt;æ˜¯&lt;/td&gt;
      &lt;td&gt;æ˜¯&lt;/td&gt;
      &lt;td&gt;å¦&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;æºå¸¦ä¿¡æ¯&lt;/td&gt;
      &lt;td&gt;æ— &lt;/td&gt;
      &lt;td&gt;User, Project, Role, Domain, Catalog ç­‰&lt;/td&gt;
      &lt;td&gt;User, Project, Role, Domain, Catalog ç­‰&lt;/td&gt;
      &lt;td&gt;User, Project ç­‰&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;æ¶‰åŠåŠ å¯†æ–¹å¼&lt;/td&gt;
      &lt;td&gt;æ— &lt;/td&gt;
      &lt;td&gt;éå¯¹ç§°åŠ å¯†&lt;/td&gt;
      &lt;td&gt;éå¯¹ç§°åŠ å¯†&lt;/td&gt;
      &lt;td&gt;å¯¹ç§°åŠ å¯†(AES)&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;æ˜¯å¦å‹ç¼©&lt;/td&gt;
      &lt;td&gt;å¦&lt;/td&gt;
      &lt;td&gt;å¦&lt;/td&gt;
      &lt;td&gt;æ˜¯&lt;/td&gt;
      &lt;td&gt;å¦&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;ç‰ˆæœ¬æ”¯æŒ&lt;/td&gt;
      &lt;td&gt;D&lt;/td&gt;
      &lt;td&gt;G&lt;/td&gt;
      &lt;td&gt;J&lt;/td&gt;
      &lt;td&gt;K&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;Token ç±»å‹çš„é€‰æ‹©æ¶‰åŠå¤šä¸ªå› ç´ ï¼ŒåŒ…æ‹¬ Keystone server çš„è´Ÿè½½ã€region æ•°é‡ã€å®‰å…¨å› ç´ ã€ç»´æŠ¤æˆæœ¬ä»¥åŠ token æœ¬èº«çš„æˆç†Ÿåº¦ã€‚region çš„æ•°é‡å½±å“ PKI/PKIZ token çš„å¤§å°ï¼Œä»å®‰å…¨çš„è§’åº¦ä¸Šçœ‹ï¼ŒUUID æ— éœ€ç»´æŠ¤å¯†é’¥ï¼ŒPKI éœ€è¦å¦¥å–„ä¿ç®¡ Keystone server ä¸Šçš„ç§é’¥ï¼ŒFernet éœ€è¦å‘¨æœŸæ€§çš„æ›´æ¢å¯†é’¥ï¼Œå› æ­¤ä»å®‰å…¨ã€ç»´æŠ¤æˆæœ¬å’Œæˆç†Ÿåº¦ä¸Šçœ‹ï¼ŒUUID &amp;gt; PKI/PKIZ &amp;gt; Fernet å¦‚æœï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Keystone server è´Ÿè½½ä½ï¼Œregion å°‘äº 3 ä¸ªï¼Œé‡‡ç”¨ UUID tokenã€‚&lt;/li&gt;
  &lt;li&gt;Keystone server è´Ÿè½½é«˜ï¼Œregion å°‘äº 3 ä¸ªï¼Œé‡‡ç”¨ PKI/PKIZ tokenã€‚&lt;/li&gt;
  &lt;li&gt;Keystone server è´Ÿè½½ä½ï¼Œregion å¤§ä¸æˆ–ç­‰äº 3 ä¸ªï¼Œé‡‡ç”¨ UUID tokenã€‚&lt;/li&gt;
  &lt;li&gt;Keystone server è´Ÿè½½é«˜ï¼Œregion å¤§äºæˆ–ç­‰äº 3 ä¸ªï¼ŒK ç‰ˆæœ¬åŠä»¥ä¸Šå¯è€ƒè™‘é‡‡ç”¨ Fernet tokenã€‚&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Sat, 26 Dec 2015 00:00:00 +0800</pubDate>
        <link>http://wsfdl.com/2015/12/26/%E7%90%86%E8%A7%A3Keystone%E7%9A%84%E5%9B%9B%E7%A7%8DToken.html</link>
        <guid isPermaLink="true">http://wsfdl.com/2015/12/26/%E7%90%86%E8%A7%A3Keystone%E7%9A%84%E5%9B%9B%E7%A7%8DToken.html</guid>
        
        
      </item>
    
      <item>
        <title>Novaæ˜¯å¦‚ä½•ç»Ÿè®¡OpenStackèµ„æº</title>
        <description>&lt;hr /&gt;

&lt;h1 id=&quot;section&quot;&gt;å¼•è¨€&lt;/h1&gt;
&lt;p&gt;è¿ç»´çš„åŒäº‹å¸¸å¸¸é‡åˆ°è¿™ä¹ˆå››ä¸ªé—®é¢˜ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Nova å¦‚ä½•ç»Ÿè®¡ OpenStack è®¡ç®—èµ„æºï¼Ÿ&lt;/li&gt;
  &lt;li&gt;ä¸ºä»€ä¹ˆ free_ram_mb,  free_disk_gb æœ‰æ—¶ä¼šæ˜¯è´Ÿæ•°ï¼Ÿ&lt;/li&gt;
  &lt;li&gt;å³ä½¿ free_ram_mb, free_disk_gb ä¸ºè´Ÿï¼Œä¸ºä»€ä¹ˆè™šæ‹Ÿæœºä¾æ—§èƒ½åˆ›å»ºæˆåŠŸï¼Ÿ&lt;/li&gt;
  &lt;li&gt;èµ„æºä¸è¶³ä¼šå¯¼è‡´è™šæ‹Ÿæœºåˆ›å»ºå¤±è´¥ï¼Œä½†æŒ‡å®šäº† host æœ‰æ—¶å´èƒ½åˆ›å»ºæˆåŠŸï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æœ¬æ–‡ä»¥ä»¥ä¸Šå››ä¸ªé—®é¢˜ä¸ºåˆ‡å…¥ç‚¹ï¼Œç»“åˆ Kilo ç‰ˆæœ¬ Nova æºç ï¼Œåœ¨é»˜è®¤ Hypervisor ä¸º Qemu-kvm çš„å‰æä¸‹(ä¸åŒ Hypervisor çš„èµ„æºç»Ÿè®¡æ–¹å¼å·®åˆ«è¾ƒå¤§ )ï¼Œæ­å¼€ OpenStack ç»Ÿè®¡èµ„æºå’Œèµ„æºè°ƒåº¦çš„é¢çº±ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;nova-&quot;&gt;Nova éœ€ç»Ÿè®¡å“ªäº›èµ„æº&lt;/h1&gt;
&lt;p&gt;äº‘è®¡ç®—çš„æœ¬è´¨åœ¨äºå°†ç¡¬ä»¶èµ„æºè½¯ä»¶åŒ–ï¼Œä»¥è¾¾åˆ°å¿«é€ŸæŒ‰éœ€äº¤ä»˜çš„æ•ˆæœï¼Œæœ€åŸºæœ¬çš„è®¡ç®—ã€å­˜å‚¨å’Œç½‘ç»œåŸºç¡€å…ƒç´ å¹¶æ²¡æœ‰å› æ­¤æ”¹å˜ã€‚å°±è®¡ç®—è€Œè¨€ï¼ŒCPUã€RAM å’Œ DISKç­‰ä¾æ—§æ˜¯å¿…ä¸å¯å°‘çš„æ ¸å¿ƒèµ„æºã€‚&lt;/p&gt;

&lt;p&gt;ä»æºç å’Œæ•°æ®åº“ç›¸å…³è¡¨å¯ä»¥å¾—å‡ºï¼ŒNova ç»Ÿè®¡è®¡ç®—èŠ‚ç‚¹çš„å››ç±»è®¡ç®—èµ„æºï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;CPU: åŒ…æ‹¬ vcpus(èŠ‚ç‚¹ç‰©ç† cpu æ€»çº¿ç¨‹æ•°),  vcpus_used(è¯¥èŠ‚ç‚¹è™šæ‹Ÿæœºçš„ vcpu æ€»å’Œ)&lt;/li&gt;
  &lt;li&gt;RAM: åŒ…æ‹¬ memory_mb(è¯¥èŠ‚ç‚¹æ€» ram)ï¼Œmemory_mb_used(è¯¥èŠ‚ç‚¹è™šæ‹Ÿæœºçš„ ram æ€»å’Œ)ï¼Œfree_ram_mb(å¯ç”¨ ram)
 Note: memory_mb = memory_mb_used + free_ram_mb&lt;/li&gt;
  &lt;li&gt;DISKï¼šlocal_gb(è¯¥èŠ‚ç‚¹è™šæ‹Ÿæœºçš„æ€»å¯ç”¨ disk)ï¼Œlocal_gb_usedï¼ˆè¯¥èŠ‚ç‚¹è™šæ‹Ÿæœº disk æ€»å’Œï¼‰ï¼Œfree_disk_gb(å¯ç”¨ disk)
 Noteï¼šlocal_gb = local_gb_used + free_disk_gb*&lt;/li&gt;
  &lt;li&gt;å…¶å®ƒï¼šPCI è®¾å¤‡ã€CPU æ‹“æ‰‘ã€NUMA æ‹“æ‰‘å’Œ Hypervisor ç­‰ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æœ¬æ–‡é‡ç‚¹å…³æ³¨ CPUã€RAM å’Œ DISK ä¸‰ç±»èµ„æºã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;nova--1&quot;&gt;Nova å¦‚ä½•æ”¶é›†èµ„æº&lt;/h1&gt;
&lt;p&gt;ä» &lt;a href=&quot;https://github.com/openstack/nova/blob/master/nova/virt/libvirt/driver.py#L4878&quot;&gt;æºç &lt;/a&gt;  å¯ä»¥çœ‹å‡ºï¼ŒNova æ¯åˆ†é’Ÿç»Ÿè®¡ä¸€æ¬¡èµ„æºï¼Œæ–¹å¼å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;CPU
    &lt;ul&gt;
      &lt;li&gt;vcpus: libvirt ä¸­ get_Info()&lt;/li&gt;
      &lt;li&gt;vcpu_used: é€šè¿‡ libvirt ä¸­ dom.vcpus() ä»è€Œç»Ÿè®¡è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰è™šæ‹Ÿæœº vcpu æ€»å’Œ&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;RAM
    &lt;ul&gt;
      &lt;li&gt;memory: libvirt ä¸­ get_Info()&lt;/li&gt;
      &lt;li&gt;memory_mb_usedï¼šå…ˆé€šè¿‡ /proc/meminfo ç»Ÿè®¡å¯ç”¨å†…å­˜ï¼Œ å†ç”¨æ€»å†…å­˜å‡å»å¯ç”¨å†…å­˜å¾—å‡º&lt;strong&gt;(èµ„æºå†ç»Ÿè®¡æ—¶ä¼šé‡æ–°è®¡ç®—è¯¥å€¼)&lt;/strong&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;DISK
    &lt;ul&gt;
      &lt;li&gt;local_gb: os.statvfs(CONF.instances_path)&lt;/li&gt;
      &lt;li&gt;local_gb_used: os.statvfs(CONF.instances_path)&lt;strong&gt;(èµ„æºå†ç»Ÿè®¡æ—¶ä¼šé‡æ–°è®¡ç®—è¯¥å€¼)&lt;/strong&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;å…¶å®ƒ
    &lt;ul&gt;
      &lt;li&gt;hypervisor ç›¸å…³ä¿¡æ¯ï¼šå‡é€šè¿‡ libvirt è·å–&lt;/li&gt;
      &lt;li&gt;PCI: libvirt ä¸­ listDevices(â€˜pciâ€™, 0)&lt;/li&gt;
      &lt;li&gt;NUMA: livirt ä¸­ getCapabilities()&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒæŒ‰ç…§ä¸Šè¿°æ”¶é›†èµ„æºçš„æ–¹å¼ï¼Œfree_ram_mb, free_disk_gb ä¸å¯èƒ½ä¸ºè´Ÿæ•°å•Šï¼åˆ«æ€¥ï¼ŒNova-compute åœ¨ä¸ŠæŠ¥èµ„æºè‡³æ•°æ®åº“å‰ï¼Œè¿˜æ ¹æ®è¯¥èŠ‚ç‚¹ä¸Šçš„è™šæ‹Ÿæœºåˆåšäº†ä¸€æ¬¡èµ„æºç»Ÿè®¡ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;nova--2&quot;&gt;Nova èµ„æºå†ç»Ÿè®¡&lt;/h1&gt;
&lt;p&gt;é¦–å…ˆåˆ†æä¸ºä»€ä¹ˆéœ€è¦å†æ¬¡ç»Ÿè®¡èµ„æºä»¥åŠç»Ÿè®¡å“ªäº›èµ„æºã€‚ä» &lt;a href=&quot;https://github.com/openstack/nova/blob/master/nova/compute/resource_tracker.py#L365&quot;&gt;æºç &lt;/a&gt;  å¯ä»¥å‘ç°ï¼ŒNova æ ¹æ®è¯¥èŠ‚ç‚¹ä¸Šçš„è™šæ‹Ÿæœºå†æ¬¡ç»Ÿè®¡äº† RAMã€DISK å’Œ PCI èµ„æºã€‚&lt;/p&gt;

&lt;p&gt;ä¸ºä»€ä¹ˆéœ€å†æ¬¡ç»Ÿè®¡ RAM èµ„æºï¼Ÿä»¥å¯åŠ¨ä¸€ä¸ª 4G å†…å­˜çš„è™šæ‹Ÿæœºä¸ºä¾‹ï¼Œè™šæ‹Ÿæœºå¯åŠ¨å‰åï¼Œå¯¹æ¯”å®¿ä¸»æœºä¸Šå¯ç”¨å†…å­˜ï¼Œå‘ç°å®¿ä¸»æœºä¸Šçš„ free memory è™½æœ‰æ‰€å‡å°‘(æœ¬æ¬¡æµ‹è¯•å‡å°‘ 600 MB)ï¼Œå´æ²¡æœ‰å‡å°‘åˆ° 4Gï¼Œå¦‚æœè™šæ‹Ÿæœºè¿è¡Œå¾ˆåƒå†…å­˜çš„åº”ç”¨ï¼Œå¯å‘ç°å®¿ä¸»æœºä¸Šçš„å¯ç”¨å†…å­˜è¿…é€Ÿå‡å°‘ 3Gå¤šã€‚è¯•æƒ³ï¼Œä»¥ 64G çš„æœåŠ¡å™¨ä¸ºä¾‹ï¼Œå‡è®¾æ¯ä¸ª 4G å†…å­˜çš„è™šæ‹Ÿæœºå¯åŠ¨åï¼Œå®¿ä¸»æœºä»…å‡å°‘ 1G å†…å­˜ï¼ŒæœåŠ¡å™¨å¯ä»¥æˆåŠŸåˆ›å»º 64 ä¸ªè™šæ‹Ÿæœºï¼Œä½†æ˜¯å½“è¿™äº›è™šæ‹Ÿæœºåœ¨è·‘å¤§é‡ä¸šåŠ¡æ—¶ï¼ŒæœåŠ¡å™¨çš„å†…å­˜è¿…é€Ÿä¸è¶³ï¼Œè½»ç€å½±å“è™šæ‹Ÿæœºæ•ˆç‡ï¼Œé‡è€…å¯¼è‡´è™šæ‹Ÿæœº shutdownç­‰ã€‚é™¤æ­¤ä»¥å¤–ï¼Œå®¿ä¸»æœºä¸Šçš„å†…å­˜å¹¶ä¸æ˜¯å®Œå…¨åˆ†ç»™è™šæ‹Ÿæœºï¼Œç³»ç»Ÿå’Œå…¶å®ƒåº”ç”¨ç¨‹åºä¹Ÿéœ€è¦å†…å­˜èµ„æºã€‚å› æ­¤å¿…é¡»é‡æ–°ç»Ÿè®¡ RAM èµ„æºï¼Œç»Ÿè®¡çš„æ–¹å¼ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;free_memory = total_memory - CONF.reserved_host_memory_mb - è™šæ‹Ÿæœºç†è®ºå†…å­˜æ€»å’Œ
CONF.reserved_host_memory_mbï¼šå†…å­˜é¢„ç•™ï¼Œæ¯”å¦‚é¢„ç•™ç»™ç³»ç»Ÿæˆ–å…¶å®ƒåº”ç”¨
è™šæ‹Ÿæœºç†è®ºå†…å­˜æ€»å’Œï¼šå³æ‰€æœ‰è™šæ‹Ÿæœº flavor ä¸­çš„å†…å­˜æ€»å’Œ
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ä¸ºä»€ä¹ˆè¦é‡æ–°ç»Ÿè®¡ DISK èµ„æºï¼ŸåŸå› ä¸ RAM å¤§è‡´ç›¸åŒã€‚ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œ qemu-kvm å¸¸ç”¨ &lt;a href=&quot;https://people.gnome.org/~markmc/qcow-image-format.html&quot;&gt;QCOW2&lt;/a&gt; æ ¼å¼é•œåƒï¼Œä»¥åˆ›å»º DISK å¤§å°ä¸º 100G çš„è™šæ‹Ÿæœºä¸ºä¾‹ï¼Œè™šæ‹Ÿæœºåˆ›å»ºåï¼Œå…¶é•œåƒæ–‡ä»¶å¾€å¾€åªæœ‰å‡ ç™¾ KBï¼Œå½“æœ‰å¤§é‡æ•°æ®å†™å…¥æ—¶ç£ç›˜æ—¶ï¼Œå®¿ä¸»æœºä¸Šå¯¹åº”çš„è™šæ‹Ÿæœºé•œåƒæ–‡ä»¶ä¼šè¿…é€Ÿå¢å¤§ã€‚è€Œ os.statvfs ç»Ÿè®¡çš„æ˜¯è™šæ‹Ÿæœºç£ç›˜å½“å‰ä½¿ç”¨é‡ï¼Œå¹¶ä¸èƒ½åæ˜ æ½œåœ¨ä½¿ç”¨é‡ã€‚å› æ­¤å¿…é¡»é‡æ–°ç»Ÿè®¡ DISK èµ„æºï¼Œç»Ÿè®¡çš„æ–¹å¼ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;free_disk_gb = local_gb - CONF.reserved_host_disk_mb / 1024 - è™šæ‹Ÿæœºç†è®ºç£ç›˜æ€»å’Œ
CONF.reserved_host_disk_mbï¼šç£ç›˜é¢„ç•™
è™šæ‹Ÿæœºç†è®ºç£ç›˜æ€»å’Œï¼šå³æ‰€æœ‰è™šæ‹Ÿæœº  flavor ä¸­å¾—ç£ç›˜æ€»å’Œ
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å½“å…è®¸èµ„æºè¶…é…(è§ä¸‹èŠ‚)æ—¶ï¼Œé‡‡ç”¨ä¸Šè¿°ç»Ÿè®¡æ–¹å¼å°±æœ‰å¯èƒ½å‡ºç° free_ram_mb,  free_disk_gb ä¸ºè´Ÿã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;section-1&quot;&gt;èµ„æºè¶…é…ä¸è°ƒåº¦&lt;/h1&gt;
&lt;p&gt;å³ä½¿ free_ram_mb æˆ– free_disk_gb ä¸ºè´Ÿï¼Œè™šæ‹Ÿæœºä¾æ—§æœ‰å¯èƒ½åˆ›å»ºæˆåŠŸã€‚äº‹å®ä¸Šï¼Œå½“ nova-scheduler åœ¨è°ƒåº¦è¿‡ç¨‹ä¸­ï¼ŒæŸäº› filter å…è®¸èµ„æºè¶…é…ï¼Œæ¯”å¦‚ CPUã€RAM å’Œ DISK ç­‰ filterï¼Œå®ƒä»¬é»˜è®¤çš„è¶…é…æ¯”ä¸ºï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;CPU: CONF.cpu_allocation_ratio = 16&lt;/li&gt;
  &lt;li&gt;RAM: CONF.ram_allocation_ratio = 1.5&lt;/li&gt;
  &lt;li&gt;DISK: CONF.disk_allocation_ratio = 1.0&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ä»¥ ram_filter ä¸ºä¾‹ï¼Œåœ¨æ ¹æ® RAM è¿‡æ»¤å®¿ä¸»æœºæ—¶ï¼Œè¿‡æ»¤çš„åŸåˆ™ä¸ºï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;memory_limit = total_memory * ram_allocation_ratio
used_memory = total_memory - free_memory
memory_limit - used_memory &amp;lt; flavor[&#39;ram&#39;]ï¼Œè¡¨ç¤ºå†…å­˜ä¸è¶³ï¼Œè¿‡æ»¤è¯¥å®¿ä¸»æœºï¼›å¦åˆ™ä¿ç•™è¯¥å®¿ä¸»æœºã€‚ 
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ç›¸å…³ä»£ç å¦‚ä¸‹(ç¨æœ‰ç²¾ç®€)ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def host_passes(self, host_state, instance_type):

    &quot;&quot;&quot;Only return hosts with sufficient available RAM.&quot;&quot;&quot;

    requested_ram = instance_type[&#39;memory_mb&#39;]
    free_ram_mb = host_state.free_ram_mb
    total_usable_ram_mb = host_state.total_usable_ram_mb

    memory_mb_limit = total_usable_ram_mb * CONF.ram_allocation_ratio
    used_ram_mb = total_usable_ram_mb - free_ram_mb
    usable_ram = memory_mb_limit - used_ram_mb

    if not usable_ram &amp;gt;= requested_ram:
        LOG.debug(&quot;host does not have requested_ram&quot;)
        return False
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å®¿ä¸»æœº RAM å’Œ DISK çš„ä½¿ç”¨ç‡å¾€å¾€è¦å°äºè™šæ‹Ÿæœºç†è®ºä½¿ç”¨çš„ RAM å’Œ DISKï¼Œåœ¨å‰©ä½™èµ„æºå……è¶³çš„æ¡ä»¶ä¸‹ï¼Œlibvirt å°†æˆåŠŸåˆ›å»ºè™šæ‹Ÿæœºã€‚&lt;/p&gt;

&lt;p&gt;éšæƒ³ï¼šå†…å­˜å’Œç£ç›˜è¶…é…è™½ç„¶èƒ½æä¾›æ›´å¤šæ•°é‡çš„è™šæ‹Ÿæœºï¼Œå½“è¯¥å®¿ä¸»æœºä¸Šå¤§é‡è™šæ‹Ÿæœºçš„è´Ÿè½½éƒ½å¾ˆé«˜æ—¶ï¼Œè½»ç€å½±å“è™šæ‹Ÿæœºæ€§èƒ½ï¼Œé‡åˆ™å¼•èµ· qemu-kvm  ç›¸å…³è¿›ç¨‹è¢«æ€ï¼Œå³è™šæ‹Ÿæœºè¢«å…³æœºã€‚å› æ­¤å¯¹äºçº¿ä¸Šç¨³å®šæ€§è¦æ±‚é«˜çš„ä¸šåŠ¡ï¼Œå»ºè®®ä¸è¦è¶…é… RAM å’Œ DISKï¼Œä½†å¯é€‚å½“è¶…é… CPUã€‚å»ºè®®è¿™å‡ ä¸ªå‚æ•°è®¾ç½®ä¸ºï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;CPU: CONF.cpu_allocation_ratio = 4&lt;/li&gt;
  &lt;li&gt;RAM: CONF.ram_allocation_ratio = 1.0&lt;/li&gt;
  &lt;li&gt;DISK: CONF.disk_allocation_ratio = 1.0&lt;/li&gt;
  &lt;li&gt;RAM-Reserve: CONF.reserved_host_memory_mb = 2048&lt;/li&gt;
  &lt;li&gt;DISK-Reserve: CONF.reserved_host_disk_mb = 20480&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h1 id=&quot;host-&quot;&gt;æŒ‡å®š host åˆ›å»ºè™šæ‹Ÿæœº&lt;/h1&gt;
&lt;p&gt;æœ¬èŠ‚ç”¨äºå›ç­”é—®é¢˜å››ï¼Œå½“æ‰€æœ‰å®¿ä¸»æœºçš„èµ„æºä½¿ç”¨è¿‡å¤šï¼Œå³è¶…å‡ºé™å®šçš„è¶…é…å€¼æ—¶(total_resource * allocation_ratio)ï¼Œnova-scheduler å°†è¿‡æ»¤è¿™äº›å®¿ä¸»æœºï¼Œè‹¥æœªæ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„å®¿ä¸»æœºï¼Œè™šæ‹Ÿæœºåˆ›å»ºå¤±è´¥ã€‚&lt;/p&gt;

&lt;p&gt;åˆ›å»ºè™šæ‹Ÿæœºçš„ API æ”¯æŒæŒ‡å®š host åˆ›å»ºè™šæ‹Ÿæœºï¼ŒæŒ‡å®š host æ—¶ï¼Œnova-scheduler é‡‡å–ç‰¹åˆ«çš„å¤„ç†æ–¹å¼ï¼šä¸å†åˆ¤æ–­è¯¥ host ä¸Šçš„èµ„æºæ˜¯å¦æ»¡è¶³éœ€æ±‚ï¼Œè€Œæ˜¯ç›´æ¥å°†è¯·æ±‚å‘ç»™è¯¥ host ä¸Šçš„ nova-computeã€‚
ç›¸å…³ä»£ç å¦‚ä¸‹(ç¨æœ‰ç²¾ç®€)ï¼š&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;def get_filtered_hosts(self, hosts, filter_properties,
            filter_class_names=None, index=0):
    &#39;&#39;&#39;Filter hosts and return only ones passing all filters.&#39;&#39;&#39;
    ...
    if ignore_hosts or force_hosts or force_nodes:
        ...
        if force_hosts or force_nodes:
            # NOTE(deva): Skip filters when forcing host or node
            if name_to_cls_map:
                return name_to_cls_map.values()

        return self.filter_handler.get_filtered_objects()
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;å½“è¯¥ host ä¸Šå®é™…å¯ç”¨èµ„æºæ—¶æ»¡è¶³è¦æ±‚æ—¶ï¼Œlibvirt ä¾æ—§èƒ½æˆåŠŸåˆ›å»ºè™šæ‹Ÿæœºã€‚æœ€åï¼Œä¸€å›¾è”½ä¹‹
 &lt;img src=&quot;http://img.blog.csdn.net/20150501235350782&quot; alt=&quot;è¿™é‡Œå†™å›¾ç‰‡æè¿°&quot; /&gt;&lt;/p&gt;
</description>
        <pubDate>Fri, 11 Dec 2015 00:00:00 +0800</pubDate>
        <link>http://wsfdl.com/openstack/2015/12/11/Nova%E6%98%AF%E5%A6%82%E4%BD%95%E7%BB%9F%E8%AE%A1OpenStack%E8%B5%84%E6%BA%90.html</link>
        <guid isPermaLink="true">http://wsfdl.com/openstack/2015/12/11/Nova%E6%98%AF%E5%A6%82%E4%BD%95%E7%BB%9F%E8%AE%A1OpenStack%E8%B5%84%E6%BA%90.html</guid>
        
        
        <category>OpenStack</category>
        
      </item>
    
      <item>
        <title>ä¸€æ¬¡æ‰¹é‡é‡å¯å¼•å‘çš„ç½‘ç»œæ•…éšœ</title>
        <description>&lt;hr /&gt;

&lt;h3 id=&quot;section&quot;&gt;ç°åœºå›é¡¾&lt;/h3&gt;
&lt;p&gt;æ•…äº‹å‘ç”ŸäºæŸä¸ªä¸‹åˆï¼Œé‡‡ç”¨ salt æ›´æ–°æŸé›†ç¾¤çš„ neutron.conf (log ç›¸å…³é…ç½®é¡¹) å¹¶æ‰¹é‡é‡å¯ neutron-openvswitch-agent(ä»¥ä¸‹ç®€ç§° neutron-ovs-agent)ï¼Œä¸ä¹…ä¾¿æœ‰äººåé¦ˆäº‘ä¸»æœºå®•æœºã€‚&lt;/p&gt;

&lt;p&gt;ç«‹å³æ’æŸ¥å‘ç°äº‘ä¸»æœºå¹¶æ²¡æœ‰å®•æœºï¼Œåªæ˜¯ç½‘ç»œä¸é€šï¼Œå¤§éƒ¨åˆ†è®¡ç®—èŠ‚ç‚¹çš„ ovs æµè¡¨ç©ºç©ºå¦‚ä¹Ÿã€‚Nova å’Œ Neutron æ‰“å‡º ERROR çº§åˆ«çš„æ—¥å¿—ã€‚&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;$ ovs-ofctl dump-flows br-bond1
NXST_FLOW repy (xid=0x4)
 cookies=0x0, duration=433.691s, table=0, n_packages=568733, n_bytes=113547542, idle_age=0, priority=1 actions=NORMAL
 cookies=0x0, duration=432.358s, table=0, n_packages=8418, n_bytes=356703, idle_age=0, priority=2, in_port=3 actions=drop&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;neutron-ovs-agent Log:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;DeviceListRetrievalError: Unable to retrieve port details for devices because of error: Remote error: TimeoutError QueuePool limit of size 10 overflow 20 reached, connection timed out, timeout 10&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;neutron-server Logï¼š&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;File â€œ/usr/lib64/python2.6/site-packages/sqlalchemy/pool.pyâ€, â€¦ â€˜TimeoutError: QueuePool limit of size 10 overflow 20 reached, connection timed out, timeout 10\nâ€™&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;nova Logï¼š&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;NeutronClientException: Request Failed: internal server error while processing your request.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸Šè¿°ä¿¡æ¯å¯å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Neutron æ—¥å¿—è¡¨æ˜ neutron-ovs-agent é€šè¿‡ rpc å‘ neutron-server è¯·æ±‚è™šæ‹Ÿæœº port ç›¸å…³ä¿¡æ¯å¤±è´¥ï¼Œå¤±è´¥çš„åŸå› æ˜¯ neutron-server å’Œæ•°æ®åº“çš„è¿æ¥æ•°è¶…å‡ºè¿æ¥æ± çš„ä¸Šé™ã€‚&lt;/li&gt;
  &lt;li&gt;Nova æ—¥å¿—è¡¨æ˜ neutron-server æ— æ³•å“åº” HTTP è¯·æ±‚ã€‚&lt;/li&gt;
  &lt;li&gt;è¢«æ¸…ç©ºçš„ ovs æµè¡¨å¯¼è‡´è™šæ‹Ÿæœºçš„ç½‘ç»œç˜«ç—ªã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;section-1&quot;&gt;å¯¼ç«ç´¢&lt;/h3&gt;
&lt;p&gt;æ·±å…¥å‰–æä¹‹å‰ï¼Œå…ˆäº†è§£è¯¥ Icehouse é›†ç¾¤çš„åŸºæœ¬ä¿¡æ¯ï¼šè¯¥é›†ç¾¤æœ‰ 102 ä¸ªè®¡ç®—èŠ‚ç‚¹ï¼Œè¿è¡Œç€ nova, neutron, glanceï¼Œceilometer ç­‰æœåŠ¡ï¼Œä¸ºäº†é¿å…å•ç‚¹æ•…éšœï¼Œæˆ‘ä»¬å»é™¤äº† neutron l3 ç­‰ç›¸å…³æœåŠ¡ï¼Œé‡‡ç”¨å¤§äºŒå±‚çš„ç½‘ç»œï¼Œè™šæ‹Ÿæœºé€šè¿‡ç‰©ç†è·¯ç”±ä¸å¤–ç•Œé€šä¿¡ã€‚ç†è®ºä¸Šè¯´ï¼Œæ— è®ºå“ªä¸ªæœåŠ¡å¼‚å¸¸ï¼Œç”šè‡³ä»»æ„èŠ‚ç‚¹å®•æœºï¼Œæœ€å·®çš„ç»“æœæ˜¯ openstack æœåŠ¡ä¸å¯ç”¨æˆ–è€…å°‘é‡è™šæ‹Ÿæœºæ•…éšœï¼Œä½†ç»å¤§éƒ¨åˆ†è™šæ‹Ÿæœºä¾æ—§èƒ½æ­£å¸¸è¿è¡Œã€‚&lt;/p&gt;

&lt;p&gt;ç»éªŒå‘ŠçŸ¥ï¼Œé‡‡ç”¨ä»¥ä¸Šç½‘ç»œæ¨¡å‹çš„å¤šä¸ªé›†ç¾¤ä¸€å¹´å¤šä»¥æ¥ä»æœªå‘ç”Ÿå¦‚æ­¤è§„æ¨¡çš„æ•…éšœã€‚ç”±äº log æ¨¡å—é…ç½®é¡¹æ ¹æœ¬ä¸ä¼šå½±å“ï¼Œç›´è§‰ä¸Šæ¨æµ‹æ‰¹é‡é‡å¯å¯èƒ½æ˜¯è§¦å‘ ovs æµè¡¨è¢«æ¸…ç©ºçš„å¯¼ç«ç´¢ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;neutron-&quot;&gt;Neutron çš„ä¸€ä¸ªå‘&lt;/h3&gt;

&lt;p&gt;ç”±äºæµè¡¨è¢«æ¸…ç©ºå‰ä»…ä»…é‡å¯äº† neutron-openvs-agentï¼Œè€Œè®¡ç®—èŠ‚ç‚¹ï¼Œä»…ä»…åªæœ‰ neutron-ovs-agent ä¸ ovs æœ‰äº¤äº’ï¼Œæ•…æŒ‰å›¾ç´¢éª¥çš„æµè§ˆ neutron-ovs-agent é‡å¯æµç¨‹ï¼Œæ¢³ç†å…¶é€»è¾‘å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;æ¸…é™¤æ‰€æœ‰æµè¡¨&lt;/li&gt;
  &lt;li&gt;é€šè¿‡ rpc å‘ neutron-server è·å–æµè¡¨ç›¸å…³ä¿¡æ¯&lt;/li&gt;
  &lt;li&gt;åˆ›å»ºæ–°æµå˜&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;ä¸éš¾å‘ç°ï¼Œå¦‚æœæ­¥éª¤ 2 å¼‚å¸¸ï¼Œæ¯”å¦‚ neutron-server ç¹å¿™ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶å¼‚å¸¸å’Œæ•°æ®åº“å¼‚å¸¸ç­‰ç§ç§å› ç´ ï¼Œéƒ½ä¼šå½±å“æµè¡¨çš„é‡å»ºï¼Œé‡åˆ™å¯¼è‡´è™šæ‹Ÿæœºç½‘ç»œç˜«ç—ªã€‚äº‹å®ä¸Šï¼Œç¤¾åŒºä¹Ÿæ„è¯†åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼šé‡å¯ neutron-ovs-agent ä¼šå¯¼è‡´ç½‘ç»œæš‚æ—¶ä¸­æ–­ã€‚&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.launchpad.net/neutron/+bug/1383674&quot;&gt;Restarting neutron ovs agent causes network hiccup by throwing away all flows&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ç¤¾åŒºçš„å¤„ç†æ–¹å¼æ˜¯å¢åŠ é…ç½®é¡¹ drop_flows_on_startï¼Œé»˜è®¤å…¶å€¼ä¸º Falseï¼Œä»è€Œé¿å…ä¸Šè¿°é—®é¢˜ã€‚è¯¥ &lt;a href=&quot;https://review.openstack.org/#/c/182920&quot;&gt;Patch&lt;/a&gt; å·²åˆå…¥ Libertyï¼Œæ¢³ç†å…¶é‡å¯çš„é€»è¾‘æµç¨‹å¦‚ä¸‹ï¼š&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;ç”¨ä¸€ä¸ª cookie æ ‡å¿—å½“å‰æµè¡¨&lt;/li&gt;
  &lt;li&gt;è·å–æ–°æµå˜å¹¶æ›´æ–°è‡³ ovs&lt;/li&gt;
  &lt;li&gt;æ ¹æ® cookie æ¸…é™¤æ—§æµè¡¨&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;neutron-ovs-agent åœ¨é‡å¯çš„è¿‡ç¨‹ä¸­å°±æµè¡¨çš„å¤„ç†ç•™ä¸‹äº†ä¸€ä¸ªéšæ‚£ï¼Œç›´æ¥çš„åæœå°±æ˜¯å¯¼è‡´è®¡ç®—èŠ‚ç‚¹çš„æµè¡¨è¢«æ¸…ç†çš„å¹²å¹²å‡€å‡€ï¼Œè™šæ‹Ÿæœºæˆä¸€ä¸ªä¸ªå­¤ç«‹çš„ç‚¹ï¼Œè€Œå¤šç§å› ç´ å¯è§¦å‘è¯¥éšæ‚£ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;section-2&quot;&gt;æœ€å¤§è¿æ¥æ•°&lt;/h3&gt;

&lt;p&gt;ç°åœ¨è§£é‡Šä¸ºä»€ä¹ˆæ‰¹é‡é‡å¯ neutron-ovs-agent ä¼šè§¦å‘ä¸Šè¿°éšæ‚£ï¼Œé‡å¯è¿‡ç¨‹ä¸­ï¼Œneutron æ—¥å¿—æŠ¥å‡ºå¦‚ä¸‹é”™è¯¯ï¼š&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;â€˜TimeoutError: QueuePool limit of size 10 overflow 20 reached, connection timed out, timeoutã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;è¿™æ¡æ—¥å¿—æ„å‘³ç€ neutron-server å’Œæ•°æ®åº“çš„è¿æ¥æ•°è¶…å‡ºå®¢æˆ·ç«¯è¿æ¥æ± çš„ä¸Šé™ï¼Œå½“ neutron-ovs-agent æ‰¹é‡é‡å¯æ—¶ï¼Œä¸Šç™¾å¹¶å‘çš„é€šè¿‡ rpc å‘ neutron-server è¯·æ±‚æ„å»ºæµè¡¨çš„ç›¸å…³ä¿¡æ¯ï¼Œneutron-server å’Œæ•°æ®åº“çš„è¿æ¥æ•°ä¹Ÿå°±è¿œè¿œè¶…è¿‡ 30ï¼Œé€ æˆå¤§é‡çš„è¯·æ±‚å¤±è´¥ï¼Œè®¡ç®—èŠ‚ç‚¹è·å–ä¸åˆ°æµè¡¨ç›¸å…³ä¿¡æ¯æ— æ³•é‡å»ºæµè¡¨ï¼Œæ•…è®¡ç®—èŠ‚ç‚¹çš„æµè¡¨ä¸ºç©ºã€‚&lt;/p&gt;

&lt;p&gt;è¦è§£å†³å›  QueuePool çš„é™åˆ¶è€Œå¼•èµ·çš„ TimeoutError é—®é¢˜ä¹Ÿå¾ˆç®€å•ï¼Œsqlalchemy æä¾›äº†ä¸¤ä¸ªé…ç½®é¡¹[1]ï¼ŒæŠŠä¸‹é¢ä¸¤ä¸ªå‚æ•°é€‚å½“è°ƒå¤§å³å¯ã€‚&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;[database] &lt;br /&gt;
max_overflowÂ = &lt;br /&gt;
max_pool_sizeÂ =&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; MySQL server é»˜è®¤æœ€å¤§è¿æ¥æ•°ä¸º 100ï¼Œå½“é›†ç¾¤çš„è§„æ¨¡ä¸Šå‡æ—¶ï¼Œéœ€é€‚å½“è°ƒæ•´ MySQL server æœ€å¤§è¿æ¥æ•°ã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;section-3&quot;&gt;è¿›ç¨‹çš„æ€§èƒ½é—®é¢˜&lt;/h3&gt;

&lt;p&gt;ç„¶è€Œé—®é¢˜å¹¶æ²¡æœ‰å®Œå…¨è§£å†³ï¼Œè¯·æ³¨æ„ nova çš„é”™è¯¯æ—¥å¿—ï¼š&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;nova.compute.manager  NeutronClientException: Request Failed: internal server error while processing your request.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;è¿™æ˜¯nova å‘ç»™ neutron-server çš„ä¸€æ¡ HTTP è¯·æ±‚ï¼Œneutron è¿”å›äº† internal server errorã€‚Internal server error å¯¹åº”çš„ HTTP status code ä¸º 500ï¼Œæ„å‘³ç€ neutron-server æ— æ³•å“åº” nova è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆä¼šæ— æ³•å“åº”å‘¢ï¼Œæ‰¹é‡é‡å¯çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç° neutron-server è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ä¸º 100 %ï¼Œæ„å‘³ç€ neutron-server æ­£å¿™äºå¤„ç† neutron-ovs-agent å¤§é‡çš„è¯·æ±‚ï¼Œå› è€Œæ— æš‡å¤„ç† nova çš„ HTTP è¯·æ±‚ã€‚&lt;/p&gt;

&lt;p&gt;è§£å†³è¯¥é—®é¢˜çš„æ–¹æ³•åŒæ ·å¾ˆç®€ç­”ï¼Œå¢åŠ æ›´å¤šçš„ neutron-server è¿›ç¨‹æ•°å³å¯ã€‚äº‹å®ä¸Šï¼Œå›  nova-conductor è¦å¤„ç† nova-compute å¤§é‡çš„ rpc è¯·æ±‚(nova-compute é€šè¿‡ nova-conductor è®¿é—®æ•°æ®åº“)ï¼Œè‡ª Icehouse èµ·ï¼Œnova-conductor å°±é»˜è®¤å¯åŠ¨äº†å¤šä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹çš„æ•°ç›®ç­‰åŒæœåŠ¡å™¨ CPU çš„é€»è¾‘æ ¸æ•°ã€‚&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;$ workers=`cat /proc/cpuinfo |grep processor |wc | awk â€˜{print $1}â€™`&lt;/p&gt;

  &lt;p&gt;[DEFAULT] &lt;br /&gt;
api_workersÂ = $workers &lt;br /&gt;
rpc_workersÂ = $workers&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;python---io&quot;&gt;Python çš„å¹¶å‘ &amp;amp; IO&lt;/h3&gt;

&lt;p&gt;å€¼å¾—æ€è€ƒçš„æ˜¯ï¼Œå¯¹åŒè·¯ 12 æ ¸å…± 24 çº¿ç¨‹çš„æœåŠ¡å™¨æ¥è¯´ï¼Œæ•°ç™¾å¹¶å‘è¯·æ±‚çœŸçš„ç®—é«˜ä¹ˆï¼Ÿneutron-server è¿›ç¨‹çš„ CPU æœ€å¤§ä½¿ç”¨ç‡åªèƒ½åˆ°è¾¾ 100 %ï¼Œæ„å‘³ç€ neutron-server ä»…ä»…åˆ©ç”¨äº†æœåŠ¡å™¨çš„ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™é‡Œä¸å¾—ä¸æåç¨‹(crontine)[2]ï¼Œè¿™ç§ä¼ªå¹¶å‘çš„â€œç”¨æˆ·æ€çº¿ç¨‹â€ æ„å‘³ç€ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªåç¨‹åœ¨æ‰§è¡Œï¼Œå³ä»»æ„æ—¶åˆ»åªèƒ½åˆ©ç”¨æœåŠ¡å™¨ CPU çš„ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œ openstack æ‰€æœ‰ç»„ä»¶çš„è¿›ç¨‹é‡Œæ»¡æ»¡éƒ½æ˜¯åç¨‹(åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹)ï¼Œå› è€Œå•ä¸ªè¿›ç¨‹ä¸‹ï¼Œneutron-server ä¸èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸çš„ä¼˜åŠ¿ä»¥æé«˜å¤„ç†å¹¶å‘çš„èƒ½åŠ›ã€‚&lt;/p&gt;

&lt;p&gt;ä¼ ç»Ÿçš„ web æœåŠ¡å™¨ apache å’Œ nginx åˆ©ç”¨å¤šè¿›ç¨‹å¤šçº¿ç¨‹æé«˜å¹¶å‘æ•°(ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼šè¿›ç¨‹ &amp;gt; çº¿ç¨‹ &amp;gt; åç¨‹)ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå•è¿›ç¨‹æ¡ä»¶ä¸‹ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ç”¨çº¿ç¨‹æ›¿æ¢åç¨‹ä»è€Œæé«˜ neutron çš„å¹¶å‘èƒ½åŠ›å‘¢ï¼ŸçœŸå®çš„ç­”æ¡ˆæ˜¯ No, æ ¹æœ¬åŸå› åœ¨äº python GIL[3]ï¼Œä¿—ç§° python å…¨å±€é”ã€‚å¯¹äº python çš„ç¨‹åºæ¥è¯´ï¼Œå•è¿›ç¨‹åªèƒ½åœ¨ä»»ä½•æ—¶åˆ»åªèƒ½å ç”¨ä¸€ä¸ªç‰©ç†çº¿ç¨‹ï¼Œæ‰€æœ‰åªæœ‰å¤šè¿›ç¨‹æ‰èƒ½å……åˆ†åˆ©ç”¨æœåŠ¡å™¨çš„å¤šæ ¸å¤šçº¿ç¨‹ã€‚&lt;/p&gt;

&lt;p&gt;è®©æˆ‘ä»¬æ·±å…¥ä¸€ç‚¹ï¼Œå‡è®¾çš„ CPU è¶³å¤Ÿå¼ºå¤§ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è§£å†³ neutron-server å•è¿›ç¨‹çš„å¹¶å‘é—®é¢˜å‘¢ï¼Ÿæˆ‘è§‰å¾—æœªå¿…ï¼Œè¿™åˆå›åˆ°äº† IO é—®é¢˜ã€‚Monkey patch[4] è™½ç„¶æŠŠç³»ç»Ÿçš„ socket åº“æ›¿æ¢æˆè‡ªå·±æä¾›çš„éé˜»å¡ socket åº“ï¼Œä»è€Œé¿å…æŸäº›é˜»å¡ IO é˜»å¡äº†æ•´ä¸ªè¿›ç¨‹(ä¸»çº¿ç¨‹)ã€‚ä½†æ˜¯ OpenStack è®¿é—® MySQL ä½¿ç”¨çš„æ˜¯ libmysqlclient åº“ï¼Œeventlet å¹¶ä¸èƒ½å¯¹è¿™ä¸ªä½¿ç”¨äº†ç³»ç»Ÿ socket çš„ C åº“ä½¿ç”¨ monky_patchï¼Œæ‰€ä»¥å¯¹ MySQL CRUD çš„æ—¶å€™ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œæ„å‘³ç€ neutron-server åœ¨è®¿é—®æ•°æ®åº“ä¹Ÿå®¹æ˜“å‡ºç°æ€§èƒ½ç“¶é¢ˆã€‚&lt;/p&gt;

&lt;p&gt;è§£å†³ä¸Šè¯‰å¹¶å‘é—®é¢˜çš„æ–¹æ³•ä¹‹ä¸€å°±æ˜¯å¯åŠ¨æ›´å¤šçš„ api worker å’Œ rpc workerã€‚åœ¨è¾ƒæ–°çš„ç‰ˆæœ¬ï¼ŒOpenStack é»˜è®¤çš„ wokers å°±æ˜¯æœåŠ¡å™¨çš„é€»è¾‘æ ¸æ•°ã€‚å¦å¤–ä¸€ç§åŠæ³•æ˜¯ç”¨ apache æ›¿æ¢ python http serverï¼Œæœ€è¿‘å„ä¸ªç»„ä»¶é€æ­¥æä¾›äº†å¯¹ apache çš„æ”¯æŒã€‚&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;reference&quot;&gt;Reference&lt;/h3&gt;

&lt;ol&gt;
  &lt;li&gt;&lt;a href=&quot;http://docs.sqlalchemy.org/en/rel_0_9/core/pooling.html&quot;&gt;http://docs.sqlalchemy.org/en/rel_0_9/core/pooling.html&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://www.dabeaz.com/coroutines/Coroutines.pdf&quot;&gt;http://www.dabeaz.com/coroutines/Coroutines.pdf&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://stackoverflow.com/questions/1294382/what-is-a-global-interpreter-lock-gil&quot;&gt;http://stackoverflow.com/questions/1294382/what-is-a-global-interpreter-lock-gil&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://stackoverflow.com/questions/11977270/monkey-patching-in-python-when-we-need-it&quot;&gt;http://stackoverflow.com/questions/11977270/monkey-patching-in-python-when-we-need-it&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
</description>
        <pubDate>Thu, 10 Dec 2015 00:00:00 +0800</pubDate>
        <link>http://wsfdl.com/openstack/2015/12/10/%E4%B8%80%E6%AC%A1%E6%89%B9%E9%87%8F%E9%87%8D%E5%90%AF%E5%BC%95%E5%8F%91%E7%9A%84%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C.html</link>
        <guid isPermaLink="true">http://wsfdl.com/openstack/2015/12/10/%E4%B8%80%E6%AC%A1%E6%89%B9%E9%87%8F%E9%87%8D%E5%90%AF%E5%BC%95%E5%8F%91%E7%9A%84%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C.html</guid>
        
        
        <category>OpenStack</category>
        
      </item>
    
  </channel>
</rss>
